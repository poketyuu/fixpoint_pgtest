# fixpoint_pgtest

フィックスポイント プログラミング試験

## 各問題に共通する基本設計

ping応答確認を行った確認日時とpingをひとまとめにして、アクセスログという形で扱う。サーバーアドレス情報とアクセスログをセットにして保存し、監視ログを1行づつ読みながら、連続してタイムアウトしていない場合は、各アドレスに対するアクセスログを更新していく。タイムアウトが連続している場合は更新を行わず、最初にタイムアウトしたアクセスログを保持し続ける。タイムアウトが終了した時点で保存されていたアクセスログと最新のアクセスログから故障期間を算出する。サーバーアドレス情報とアクセスログはmapを用いて保存、更新を行う。

### GetTMFromStringメソッド

文字列形式で与えられる時系列データを時間を扱うのに長けたtm構造体に変換するメソッド。

### Addressクラス

監査ログを読み込んで得られたサーバアドレス文字列から32bitのアドレスを構築し、ネットワークプレフィックス長とともに保存する。ネットワークアドレス部分を返すsubsetメソッド、出力の際に32bitのアドレスを文字列形式に変換するGetStringメソッド、ネットワークアドレスのみの文字列に変換するGetSubnetStringメソッドを用意している。また、本クラスはmapのキーとして持ちいており、mapは二部探索木によって高速なアクセスを実現していることから、比較演算子を定義している。

### AccessLogクラス

ping応答確認を行った時間情報とタイムアウトしたか否かのフラグ、タイムアウトしなかった場合にはそのping値を保存する。時間情報を文字列に復元するOutputAccesstimeメソッドが用意されており、復元の際にping値を含めた値を出力するかどうかを引数isendにて指定できる。

### Errlogクラス

故障期間や過負荷状態期間を出力するためのデータをまとめるのに使用しているクラスであり、サーバーアドレス、期間の開始と終わり、その間の秒数を保存している。故障や過負荷が発生して、終了が確認された時点でvectorにこのクラスを追加し、出力を行う。

## 設問1

基本設計に基づき、タイムアウトが終了した時点でタイムアウト開始時のアクセスログと最新のアクセスログから故障期間を算出しErrlogをリストに加え、csv形式で出力する。サーバアドレス、故障期間、故障時間(秒)が出力される。`./q1 filename`とコマンドを打つとserverlog.csvに結果が出力される。

## 設問2

アクセスログに連続でタイムアウトした回数を記録するmisscountという変数を追加し、保存されているアクセスログと現在のアクセスログがともにタイムアウトしている場合にそのカウントを1増加させる。タイムアウトが終了した時点で保存されていたアクセスログのmisscountがパラメータN以上である時のみ故障期間を算出してErrlogをリストに加えるようにする。`./q2 filename N`とコマンドを打つとserverlog_renew.csvに結果が出力される。

## 設問3

直近m回のタイムアウトしていないアクセスログを保存するためにAccessLogQueueというクラスを追加した。直近m回の成功したアクセスログを保存するため、fifo方式でデータを保存できるqueueを用いる。アクセスが成功している場合のみqueueにデータを追加し,そのサイズがmを超えた場合に先頭の要素を取り出す。queueは全要素にアクセスできないため、queueに含まれている全アクセスログのpingの和を保存する変数を用意し、データ追加の際にはこの値も更新している。mapでkeyであるサーバーアドレス情報に対応するvalueをアクセスログ単体からアクセスログとこのキューのペアーにして保存するように変更した。データ追加のたびに直近m回の平均を算出し、tミリ秒を超えている場合には現在過負荷状態のサーバーを保存するmapのoverloadmonitorに存在しない場合は追加し、過負荷状態が終了した時点でoverloadmonitorから値を削除してErrlogを過負荷状態用のリストに加える。`./q3 filename N m t`とコマンドを打つことで、過負荷状態のログはoverloadlog.csvに出力される。

## 設問4

サブネット内の各サーバアドレスとそのタイムアウト状態を保持するmapを用意し、各インターネットアドレスとそのmapを保持するmapを作成する。各アドレスがN回連続でタイムアウトした時点でサーバアドレスに対応するタイムアウト状態のフラグを変更し、その時点でサブネット内の全てのmap要素のフラグがtrueとなっていれば、そのサブネットが故障しているとみなし、故障しているサブネットを保存するmapのsubnetmonitorに値を追加する。サブネット内いずれかのサーバーがタイムアウト状態から脱したらsubnetmonitorから値を削除し、Errlogをサブネット故障用のリストに加える。`./q4 filename N m t`とコマンドを打つことで、サブネット故障のログはsubnetlog.csvに出力される。

## テストデータと結果の検証

今回、以下の3つのテストデータを作成し、検証を行なった。まず初めにsimpletestdata.csvというデータについてはサーバアドレスが2x2の4種類、データが40行あり、これについては人力で作成し、予期したデータが出力されるかを確認した。次にtestdata.csv,testdata2.csvというデータについては、いずれもpythonを用いてgenerate_testdata.pyを実行することで作成した。いずれもデータは10万行あり、testdata.csvでは10x10の100種類のサーバアドレス、testdata2.csvでは50x2の100種類のサーバアドレスを乱数により生成している。pingについても全て乱数で決定しており、20%の確率でタイムアウトになるようにした。これらのデータに関しては全てをチェックすることはできないので初めの数行を確認した他、行数が想定の範囲内であるかで検証を行い、いずれのデータについてもその正確性が得られたと判断した。

## 課題

10万行のデータを読み込んだ際にはやはり出力にかなりの時間を要してしまい、ここをもっと改善していかねばならないと感じた。
